name: Quality Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  jekyll-build:
    name: Jekyll Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1.7'
          bundler-cache: true

      - name: Build Jekyll site
        run: |
          bundle exec jekyll build --strict_front_matter
        env:
          JEKYLL_ENV: production

      - name: Verify build output
        run: |
          test -d _site
          test -f _site/index.html
          test -d _site/policies
          echo "✅ Jekyll build completed successfully"

      - name: Upload site artifact
        uses: actions/upload-artifact@v4
        with:
          name: jekyll-site
          path: _site/
          retention-days: 1

  html-validation:
    name: HTML Validation
    runs-on: ubuntu-latest
    needs: jekyll-build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built site
        uses: actions/download-artifact@v4
        with:
          name: jekyll-site
          path: _site/

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install html-validate
        run: npm install -g html-validate

      - name: Create html-validate config
        run: |
          cat > .htmlvalidate.json << 'EOF'
          {
            "extends": ["html-validate:recommended"],
            "rules": {
              "no-inline-style": "off",
              "require-sri": "off"
            }
          }
          EOF

      - name: Validate HTML
        run: |
          html-validate "_site/**/*.html" || true
          echo "✅ HTML validation completed"

  accessibility:
    name: Accessibility Testing
    runs-on: ubuntu-latest
    needs: jekyll-build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built site
        uses: actions/download-artifact@v4
        with:
          name: jekyll-site
          path: _site/

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm init -y
          npm install --save-dev @playwright/test @axe-core/playwright

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create accessibility test
        run: |
          cat > accessibility-test.js << 'EOF'
          const { test, expect } = require('@playwright/test');
          const { injectAxe, checkA11y } = require('axe-playwright');
          const fs = require('fs');
          const path = require('path');

          const baseURL = 'http://localhost:8080';
          const axeConfig = {
            runOnly: {
              type: 'tag',
              values: ['wcag2a', 'wcag2aa', 'wcag22aa']
            }
          };

          const criticalViolationsThreshold = 0;
          const seriousViolationsThreshold = 0;

          test.describe('Accessibility Tests', () => {
            test.beforeEach(async ({ page }) => {
              await injectAxe(page);
            });

            test('Home page', async ({ page }) => {
              await page.goto(`${baseURL}/index.html`);
              await checkA11y(page, null, axeConfig, (violations) => {
                const critical = violations.filter(v => v.impact === 'critical');
                const serious = violations.filter(v => v.impact === 'serious');
                
                expect(critical.length, `Critical violations found: ${critical.length}`).toBeLessThanOrEqual(criticalViolationsThreshold);
                expect(serious.length, `Serious violations found: ${serious.length}`).toBeLessThanOrEqual(seriousViolationsThreshold);
              });
            });

            test('Policy index', async ({ page }) => {
              await page.goto(`${baseURL}/policies/index.html`);
              await checkA11y(page, null, axeConfig, (violations) => {
                const critical = violations.filter(v => v.impact === 'critical');
                const serious = violations.filter(v => v.impact === 'serious');
                
                expect(critical.length, `Critical violations found: ${critical.length}`).toBeLessThanOrEqual(criticalViolationsThreshold);
                expect(serious.length, `Serious violations found: ${serious.length}`).toBeLessThanOrEqual(seriousViolationsThreshold);
              });
            });

            test('Sample policy page', async ({ page }) => {
              const policiesDir = path.join(__dirname, '_site', 'policies');
              const policyFiles = fs.readdirSync(policiesDir).filter(f => f.endsWith('.html'));
              
              if (policyFiles.length > 0) {
                await page.goto(`${baseURL}/policies/${policyFiles[0]}`);
                await checkA11y(page, null, axeConfig, (violations) => {
                  const critical = violations.filter(v => v.impact === 'critical');
                  const serious = violations.filter(v => v.impact === 'serious');
                  
                  expect(critical.length, `Critical violations found: ${critical.length}`).toBeLessThanOrEqual(criticalViolationsThreshold);
                  expect(serious.length, `Serious violations found: ${serious.length}`).toBeLessThanOrEqual(seriousViolationsThreshold);
                });
              }
            });
          });
          EOF

      - name: Start local server
        run: |
          cd _site
          python3 -m http.server 8080 &
          sleep 3
          echo "✅ Server started on port 8080"

      - name: Run accessibility tests
        run: npx playwright test accessibility-test.js

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-results
          path: playwright-report/
          retention-days: 7

  javascript-quality:
    name: JavaScript Quality
    runs-on: ubuntu-latest
    if: false  # Enable when JS files exist
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ESLint
        run: npm install -g eslint

      - name: Create ESLint config
        run: |
          cat > .eslintrc.json << 'EOF'
          {
            "env": {
              "browser": true,
              "es2021": true
            },
            "extends": "eslint:recommended",
            "parserOptions": {
              "ecmaVersion": 12,
              "sourceType": "script"
            },
            "rules": {
              "no-console": "off",
              "no-unused-vars": "warn"
            }
          }
          EOF

      - name: Lint JavaScript
        run: |
          if [ -d "assets/js" ]; then
            eslint "assets/js/**/*.js" || exit 1
          fi
          if [ -d "tools" ]; then
            eslint "tools/**/*.js" || exit 1
          fi
          echo "✅ JavaScript quality checks passed"

  security-privacy:
    name: Security & Privacy Check
    runs-on: ubuntu-latest
    needs: jekyll-build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built site
        uses: actions/download-artifact@v4
        with:
          name: jekyll-site
          path: _site/

      - name: Check for tracking code
        run: |
          echo "Checking for third-party analytics..."
          
          # Check for common analytics/tracking services
          if grep -r "google-analytics\|googletagmanager\|ga\.js\|gtag\.js\|analytics\.js" _site/ 2>/dev/null; then
            echo "❌ Google Analytics detected"
            exit 1
          fi
          
          if grep -r "facebook\.com/tr\|facebook\.net\|fbevents\.js" _site/ 2>/dev/null; then
            echo "❌ Facebook tracking detected"
            exit 1
          fi
          
          if grep -r "hotjar\|mouseflow\|crazyegg" _site/ 2>/dev/null; then
            echo "❌ User tracking/recording detected"
            exit 1
          fi
          
          echo "✅ No third-party tracking detected"

      - name: Check for localStorage/sessionStorage usage
        run: |
          echo "Checking for storage usage..."
          
          if grep -r "localStorage\|sessionStorage" _site/ 2>/dev/null; then
            echo "⚠️  localStorage/sessionStorage usage detected - verify it's documented"
            # Don't fail, just warn
          else
            echo "✅ No storage usage detected"
          fi

      - name: Check for external script sources
        run: |
          echo "Checking for external scripts..."
          
          # Allow specific domains
          if grep -r "<script.*src=" _site/ | grep -v "relative_url" | grep -v "http://localhost" | grep -v "127.0.0.1" 2>/dev/null; then
            echo "⚠️  External scripts detected - verify they are necessary"
            grep -r "<script.*src=" _site/ | grep -v "relative_url" || true
          else
            echo "✅ No unexpected external scripts"
          fi
